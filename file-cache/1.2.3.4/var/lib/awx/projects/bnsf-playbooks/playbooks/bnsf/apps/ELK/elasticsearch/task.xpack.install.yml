- name: "Download: {{xPackClientPlugin.payloadName}}" 
  get_url:
    url:  "{{xPackClientPlugin.payloadName}}"
    dest: "./{{xPackClientPlugin.packageName}}"
    mode: 0770

- name: "Check if java is installed: /usr/bin/java"
  stat:
   path: "/user/bin/java"
  register: javaPath

- name: "Install RHEL package: java"
  become: yes
  yum:
    name: "java"
    state: present
  when: ansible_distribution == "RedHat" and javaPath.stat.exists == False

- name: "Install Fedora package: java"
  become: yes
  dnf:
    name: "java"
    state: present
  when: ansible_distribution == "Fedora" and javaPath.stat.exists == False

- name: "Install elasticsearch plugin: {{elasticSearch.binDirectory}}/elasticsearch-plugin install -b file://{{ansible_env.HOME}}/{{xPackClientPlugin.packageName}}"
  become: yes
  shell: "{{elasticSearch.binDirectory}}/elasticsearch-plugin install -b file://{{ansible_env.HOME}}/{{xPackClientPlugin.packageName}}"


- name: "Assign template parameters"
  set_fact:
   template_src: "{{ templates ~ '/role_mapping_pki.{{chef_environment}}.yml' }}"
   template_dest: "{{ elasticSearch.xpackConfigDirectory ~ '/role_mapping_pki.yml' }}"

- name: "Build template: {{ template_dest  }} <= {{template_src}}"
  template:
    dest: "{{ template_dest }}"
    src:  "{{ template_src  }}"
    owner: "{{ elk.userName }}"
    group: "{{ elk.groupName }}"
    mode: 0660


- name: "Add role mapping file"
  include_tasks: task.xpack.role.add_roles.yml

- name: "Check if path exists: {{elk.mwelkCreds}}"
  stat:
   path: "{{elk.mwelkCreds}}"
  register: pathInfo

- name: "Copy credetials: {{elasticSearch.xpackConfigDirectory}}"
  copy: 
    src: "{{elk.mwelkCreds}}"
    dest: "{{elasticSearch.xpackConfigDirectory}}"
    directory_mode: yes
  when: pathInfo.stat.exists


