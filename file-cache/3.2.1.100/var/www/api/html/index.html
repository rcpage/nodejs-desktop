<!DOCTYPE html>
<html>
  <head>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script src="https://editor.datatables.net/extensions/Editor/js/dataTables.editor.min.js"></script>

    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://editor.datatables.net/extensions/Editor/css/editor.dataTables.min.css"/>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script type="text/javascript" src="DataTables/datatables.min.js"></script>

    <meta charset=utf-8 />
    <title>Device Manager</title>
    <style>

      td.material-icons {
        cursor: pointer;
        display: block;

      }
      #device-table.dataTable.display tbody td,
      #signal-table.dataTable.display tbody td{

      }

      table.dataTable tbody>tr.selected, table.dataTable tbody>tr>.selected {
        background-color: #007bff;
      }


      table.dataTable.display tbody>tr.expanded {
        font-weight: bold;
        color: #333;
      }

      table.dataTable tbody>tr.selected,
      table.dataTable tbody>tr>.selected,
      table.dataTable.hover tbody>tr.selected:hover, 
      table.dataTable.hover tbody>tr>.selected:hover, 
      table.dataTable.display tbody>tr.selected:hover, 
      table.dataTable.display tbody>tr>.selected:hover,
      table.dataTable.stripe tbody>tr.odd.selected, 
      table.dataTable.stripe tbody>tr.odd>.selected, 
      table.dataTable.display tbody>tr.odd.selected, 
      table.dataTable.display tbody>tr.odd>.selected 
      {
        font-weight: bold;
        background-color: #d43737;
        background-color: #007bff;
      }

      #device-table table.dataTable {

        border: solid 1px #ccc;
        transition: all 0.2s ease-in-out;
      }


      #device-table td.device-interface {
        width: 100%;
        max-width: 150px;
        overflow: hidden;
      }

      button.btn, 
      button.btn-secondary,
      button.btn-secondary.disabled {
        background-color: #333;
        padding: 2px;
        border-radius: 0;
      }	

      .container, #table-panel, #panel-left{
        height: 100%;
      }

      td.details-control {
        background: url('https://cdn.rawgit.com/DataTables/DataTables/6c7ada53ebc228ea9bc28b1b216e793b1825d188/examples/resources/details_open.png') no-repeat center center;
        cursor: pointer;
        width: 20px;
      }
      tr.shown td.details-control {
        background: url('https://cdn.rawgit.com/DataTables/DataTables/6c7ada53ebc228ea9bc28b1b216e793b1825d188/examples/resources/details_close.png') no-repeat center center;
        width: 20px;
        cursor: pointer;
      }

      body {
        font: 90%/1.45em "Helvetica Neue", HelveticaNeue, Verdana, Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        background-color: #ececec;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      table.dataTable tbody td  {
        word-break: break-word;
        vertical-align: top;
        white-space: normal;
      }

      table.dataTable .wrap {

        word-break: break-word;
        vertical-align: top;
        white-space: normal;
        overflow: hidden;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button
      {
        padding: 0px;
      }

      #table-panel {
        display: table;
        border: solid 1px #CCC;
        border-top: none;
        width: 100%;
        background-color: #ccc;
      }

      .panel-header {
        background: #333;
        color: white;
        padding: 3px 10px;
        margin:0;
        font-size: 20px;
      }

      #left-panel {
        display: table-cell;
        width: 250px;
        height: 100%;
        border-right: solid 1px #ccc;
      }

      #device-panel {
        position: absolute;
        overflow: hidden;
        overflow-y: scroll;
        cursor: pointer;
        bottom: 0;
        top: 30px;
        width: 250px;
      }

      #signal-panel {
        height: 90%;
        overflow-y: scroll;
        background-color: #fff;
      }

      table.dataTable tbody th, table.dataTable tbody td{
        padding: 2px 5px; 
      }

      #signal-panel tbody > tr td:nth-child(2){

        width: 200px;
      }


      #device-table thead, #interface-table thead, #signal-table thead {
        display:none;

      }

      #interface-panel {
        height: 200px;
        overflow: hidden;
        overflow-y: scroll;
        cursor: pointer;
        display:none;
      }

      #center-panel {
        display: table-cell;

        vertical-align: top;
      }

      .signal-detail-table tbody tr td{
        padding: 5px; 
      }

      table.signal-detail-table tbody > tr > td:nth-child(1){
        width: 50px; 
        text-align: right; 
        font-weight: bold; 
        border-right: solid 1px #ccc;
      }

      .signal-detail-table {
        width: 100%; 

      }

      #signal-table, #device-table, #interface-table {
        margin: 0px !important;
      }

      div.dt-buttons {
        display:none; 
      }

    </style>
  </head>
  <body>
    <div class="container">
      <div id="table-panel">
        <div id="left-panel">
          <h1 class="panel-header">Device Manager</h1>
          <div id="device-panel">
            <table id="device-table" class="display nowrap" cellspacing="0" width="100%">
              <tr>
                <th></th>
                <th>device</th>
              </tr>
              <tbody>

              </tbody>
            </table>
          </div>

        </div>

        <div id="center-panel">
          <h1 id="nav-header" class="panel-header">&nbsp;</h1>
          <div id="signal-panel">
            <table id="signal-table" class="display nowrap" cellspacing="0" width="100%">
              <thead>
                <tr>
                  <th></th>

                  <th>signal</th>
                  <th>description</th>


                </tr>
              </thead>
              <tbody id="table-body">

              </tbody>

            </table>
          </div>  
        </div>
      </div>
    </div>

    <script>

      function windowResizeEventHandle(e){
        console.log('resized');
        var h = $('#center-panel').height() - $('#nav-header').outerHeight()
        $('#signal-panel').height(h)
      }

      $(document).ready(function() {

        $(window).on('resize', windowResizeEventHandle);



        windowResizeEventHandle();

        window.DEVICE_OBJECT = null;
        window.SIGNAL_INTERFACE = null;

        window.signalEditor = new $.fn.dataTable.Editor({
          ajax: "http://3.2.1.100:3000/api/device/interface/signals",
          table: '#signal-table',
          fields: [
            //{
            //  label: "signal_id:",
            //  name: "signal_id"
            //}, 
            //{
            // label: "interface_id:",
            // name: "interface_id"
            //}, 
            {
              label: "signal name:",
              name: "signal_name"
            }, 

            {
              label: "channels:",
              name: "channels"
            }, 

            {
              label: "description:",
              name: "description",
              type: 'textarea',
              attr: {
                placeholder: "Please enter a description here"
              }
            }, 
            //{
            //  label: "attributes:",
            //  name: "attributes"
            //}
          ],
          formOptions: {
            inline: {
              message: "fred",
              title: "steve"
            }
          }    
        });

        window.deviceEditor = new $.fn.dataTable.Editor({
          ajax: "http://3.2.1.100:3000/api/device/list",
          table: '#device-table',
          fields: [
            {
              label: "device_name:",
              name: "device_name"
            }
          ]
        })







        window.deviceDataTable = $("#device-table").DataTable({
          stripeClasses: [],
          autoWidth: false,
          paging: false,
          searching: false,
          info: false,
          ordering: false,
          dom: "Bfrtip",
          select: false,
          "ajax": {
            "url": "http://3.2.1.100:3000/api/device/list",
            "data": function ( d ) {
              //d.id = $('#interfaces').val() || 162;
            }
          },
          "columns": [
            {
              "className":      'material-icons',
              "orderable":      false,
              "data":           null,
              "defaultContent": 'add'
            },
            { "data": "device_name" },         
          ],
          buttons: [
            { extend: "create", editor: deviceEditor },
            //{ extend: "edit", editor: deviceEditor },
            //{ extend: "remove", editor: deviceEditor }
          ]
        }).on( 'select.dt', function ( e, dt, type, indexes ) {
          var data = dt.rows(indexes).data();
          console.log(data);
          //interfaceDataTable.ajax.reload();
        });


        $('#device-table').on( 'dblclick', 'tbody td', function (e) {

          if($(e.target).closest('table').attr('id') == 'device-table' && 
             $(e.target).closest('tr').attr('role') == 'row'){
            deviceEditor.inline( this );
          }

        })

        function FootprintDataTable(data){
          console.log('data', data);
          var $tbl = $('<table class="display" width="100%"></table>');
          var dt = $tbl.DataTable ({
            "stripeClasses": [],
            autoWidth: false,
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            scrollY: '200px',
            scrollCollapse: true,
            //dom: "Bfrtip",
            data : data,
            columns : [
              { title: 'pin_id', "data" : "pin_id" },
              { title: 'signal', "data" : "signal" },
              { title: 'number', "data" : "number" },
              //{ title: 'dimensions', "data" : "dimensions" }
            ]
          });

          return $tbl;
        }


        function PropertyValueDataTable(properties){
          var data = [];

          if(properties instanceof Array){
            data = properties;
          }
          else {
            for(var field in properties){
              data.push({ property: field , value: properties[field] })
            }
          }



          var $tbl = $('<table class="display" width="100%"></table>');
          var dt = $tbl.DataTable ({
            "stripeClasses": [],
            autoWidth: false,
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            //dom: "Bfrtip",
            data : data,
            columns : [
              { title: 'property', "data" : "property" },
              { title: 'value', "data" : "value" }
            ]
          });
          //$tbl.find('thead').hide();
          //$('#device-panel').append($tbl)
          return $tbl;
        }



        window.signalDataTable = $("#signal-table").DataTable({
          autoWidth: false,
          paging: false,
          searching: false,
          info: false,
          ordering: false,
          dom: "Bfrtip",
          "ajax": {
            "url": "http://3.2.1.100:3000/api/device/interface/signals",
            "data": function ( d ) {
              d.id = window.SIGNAL_INTERFACE ? window.SIGNAL_INTERFACE.interface_id : 0;
            }
          },
          "columnDefs": [
            //{ "width": "20px", "targets": [0,1] },
            //{ "width": "200px", "targets": [2] },
            //{ "width": "90%", "targets": 3 }
          ],
          "columns": [
            {
              "className":      'material-icons',
              "orderable":      false,
              "data":           null,
              "defaultContent": 'add',

              "width": '50px'
            },
            //{ 
            //  "data": "signal_id",
            //  "visible": false
            //}, 
            { 
              "data": 'signal_name',
              render: function (data, type, row){
                return '<div class="wrap"><div style="white-space:nowrap; max-width: 200px; min-width: 100px;">'+ data + '</div></div>';
              }
            },       
            //{ 
            //  "data": "channels"
            //},
            { 
              "data": "description", 

              render: function ( data, type, row ) {

                return '<div class="wrap"><div style="white-space:nowrap; max-width: 300px; min-width: 100px;">'+ data + '</div></div>';
              } 
            }
          ],
          select: false,
          //keys: true,
          buttons: [
            { extend: "create", editor: signalEditor },
            { extend: "edit", editor: signalEditor },
            { extend: "remove", editor: signalEditor }
          ]
        });

        $('#signal-table').on( 'dblclick', 'tbody td', function () {
          signalEditor.inline( this , {
            buttons: { className:'material-icons', label: 'post_add', fn: function () { this.submit(); } }
          });
        })

        signalEditor.on('postSubmit', function(e, json, data, action, xhr){
          console.log(e, json, data, action);
          signalDataTable.ajax.reload();
        });

        signalEditor.on( 'initEdit', function ( e, node, data, items, type ) {
          signalEditor.one('open', function () {
            signalEditor.displayed().forEach(function(a) {
              //signalEditor.field(a).val(a);
            });
          });  
        });



        function format ( device, interface, signal, pads ) {



          var json = JSON.parse(signal.attributes);
          // `d` is the original data object for the row
          var $tbl= $('<table class="signal-detail-table" cellpadding="0" cellspacing="0" border="0">'+

                      '<tr>'+
                      '<td>description</td>'+
                      '<td><pre class="wrap" style="width:100%; text-align: left;">'+signal.description+'</pre></td>'+
                      '</tr>'+

                      '<tr>'+
                      '<td>device</td>'+
                      '<td>'+device.device_name+' (id='+device.device_id+')</td>'+
                      '</tr>'+

                      '<tr>'+
                      '<td>interface</td>'+
                      '<td>'+interface.interface_name+' (id='+interface.interface_id+')</td>'+
                      '</tr>'+

                      '<tr>'+
                      '<td>signal</td>'+
                      '<td>'+signal.signal_name+' (id='+signal.signal_id+')</td>'+
                      '</tr>'+           

                      '<tr>'+
                      '<td>footprint</td>'+
                      '<td><pre style="width:100%; min-height: 150px;">'+JSON.stringify(pads, null, 2)+'</pre></td>'+
                      '</tr>'+   

                      '<tr>'+
                      '<td>channels</td>'+
                      '<td>'+signal.channels+'</td>'+
                      '</tr>'+

                      '<tr>'+
                      '<td>attributes</td>'+
                      '<td><pre style="width:100%; min-height: 150px;">'+JSON.stringify(json,null,2)+'</pre></td>'+
                      '</tr>'+


                      '</table>');

          var propertyValueTable = PropertyValueDataTable(json);
          $tbl.find('tr:nth-last-child(1) td:eq(1)').html(propertyValueTable);

          var padsPropertyValueTable = FootprintDataTable(pads);
          $tbl.find('tr:nth-last-child(3) td:eq(1)').html(padsPropertyValueTable);

          return $tbl;

        }

        function formatDeviceDetails ( interfaces ) {


          var tableID = 'tbl-editor-'+Date.now();



          var $tbl = $('<table id="'+tableID+'" class="display"></table>');

          var tblEditor = new $.fn.dataTable.Editor({
            table: $tbl,
            fields: [
              {
                label: "interface_name:",
                name: "interface_name"
              }
            ]
          });

          var dt = $tbl.DataTable ({
            stripeClasses: [],
            ajax: {
              url: "http://3.2.1.100:3000/api/device/interface/list",
              data: function ( d ) {
                d.id = $('#interfaces').val() || 162;
              }
            },
            autoWidth: false,
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            dom: "Bfrtip",
            data : interfaces,
            select: true,
            columns : [
              { title: 'interface_name', "data" : "interface_name", className: 'device-interface' },
              {
                "className":      'material-icons',
                "orderable":      false,
                "data":           null,
                "defaultContent": 'arrow_forward_ios'
              },
            ],
            buttons: [
              { extend: "create", editor: tblEditor },
              //{ extend: "edit", editor: deviceEditor },
              //{ extend: "remove", editor: deviceEditor }
            ]

          });

          $tbl.on( 'dblclick', 'tbody td', function () {
            $(this).parent().removeClass('selected')
            tblEditor.inline( this );
          })



          //$tbl.find('thead').hide();
          //$('#device-panel').append($tbl)
          return $tbl;

          //return table;
        }

        function handleDeviceClick(e, tr, row, interface){

          $('#device-panel').find('tr').removeClass('selected');

          var $detail_tr = $(e.target).parent(),
              $detail_tbody = $detail_tr.parent();

          var index =$detail_tr.index(),
              data = interface.data[index];

          $detail_tr.addClass('selected');

          var deviceDetail = row.data(),
              interfaceDetail = data;

          //console.log(deviceDetail, interfaceDetail)

          window.SIGNAL_INTERFACE = interfaceDetail;
          window.DEVICE_OBJECT = deviceDetail;

          signalDataTable.ajax.reload();

          $('#nav-header').html([row.data().device_name,">", data.interface_name].join(' '));
        }


        // Add event listener for opening and closing details
        $('#signal-table tbody').on('click', 'td.material-icons', function () {
          var cell = this;
          var tr = $(this).closest('tr');
          var row = signalDataTable.row( tr ),
              signal = row.data();

          console.log('signal', signal);

          fetchSignalFootprints(DEVICE_OBJECT, signal, pads=>{

            console.log('pads',pads)



            if ( row.child.isShown() ) {
              // This row is already open - close it
              row.child.hide();
              tr.removeClass('shown');
              tr.removeClass('selected');
              cell.innerHTML = 'add';
            }
            else {
              // Open this row
              row.child( format( DEVICE_OBJECT, SIGNAL_INTERFACE, signal, pads ) ).show();
              tr.addClass('shown');
              tr.addClass('selected');
              cell.innerHTML = 'remove';
            }

          });

        } );


        function fetchDeviceRowDetails(device, tr, row, cb){
          $.get("http://3.2.1.100:3000/api/device/interface/list", { id: device.device_id }, function(interfaceList){
            if(cb) cb(device, interfaceList, tr, row);
          });
        }

        function fetchSignalFootprints(device, signal, cb){
          $.get('http://3.2.1.100:3000/api/device/footprints', { id: device.device_id }, function(footprints){
            var pads = footprints.filter((pad,i)=>{ return pad.signal_id == signal.signal_id });
            if(cb) cb(pads)
              });
        }


        // Add event listener for opening and closing details
        $('#device-table tbody').on('click', 'td.material-icons', function () {
          var cell = this;
          var deviceTblRow = $(this).closest('tr');
          var deviceDataTableRow = deviceDataTable.row( deviceTblRow );

          console.log(deviceDataTableRow.to$())

          if ( deviceDataTableRow.child.isShown() ) {
            // This row is already open - close it
            deviceDataTableRow.child.hide();
            deviceTblRow.removeClass('shown');
            deviceTblRow.removeClass('expanded');
            cell.innerHTML = 'add';
          }
          else {
            fetchDeviceRowDetails(deviceDataTableRow.data(), deviceTblRow, deviceDataTableRow, function (device, interface, tblRow, dtRow) {

              // Open this row
              var $deviceInterfaceList = $(formatDeviceDetails( interface.data ));
              dtRow.child( $deviceInterfaceList ).show();
              tblRow.addClass('shown');
              tblRow.addClass('expanded');
              cell.innerHTML = 'remove';
              //console.log('ok, now what?', $deviceInterfaceList.DataTable())

              $($deviceInterfaceList).on('click', 'td.device-interface', function(tdClickEvent){
                handleDeviceClick(tdClickEvent, tblRow, dtRow, interface); // !important 
                tdClickEvent.preventDefault();
              });

            });
          }
        } );
      });


    </script>
  </body>
</html>