<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
-->
    <title>Device Signal Manager</title>
  </head>
  <body>




    <div id="addDevice" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Device</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Device Name:</p>
            <input id="new-device-name" type="text" placeholder="device name" />
          </div>
          <div class="modal-footer">
            <button id="btn-add-device" type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="addInterface" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Interface</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <label>Device Name:</label>
            <select id="new-interface-device-select" class="device-dialog" style="float:right">
            </select>
            <br />
            <label>Interface Name:</label>
            <input id="new-interface-name" type="text" placeholder="interface name"  style="float:right" />
          </div>
          <div class="modal-footer">
            <button id="btn-add-interface" type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="addSignal" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Signal</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <label>Device Name:</label>
            <select id="new-signal-device-select" class="device-dialog" style="float:right">
            </select>
            <br/>
            <label>Interface Name:</label>
            <select id="new-signal-interface-select" class="interfaces-dialog" style="float:right">
            </select>
            <br/>
            <label>Signals:</label>
            <select id="new-signal-select" style="float:right">
            </select>
            <br/>
            <label>Signal Name:</label>
            <input id="new-signal-name" type="text" placeholder="signal name" style="float:right" />
            <br/>
            <label>I/O Type:</label>
            <input id="new-signal-io-type" type="text" placeholder="i/o type" style="float:right" />
            <br/>
            <label>I/O Buffer Type:</label>
            <input id="new-signal-io-buffer-type" type="text" placeholder="i/o buffer type" style="float:right" />
            <br/>
            <label>Ball Count:</label>
            <input id="new-signal-ball-count" type="text" placeholder="ball count" style="float:right" />
            <br/>
            <label>Internal Resistor Pull-up/Pull-down:</label>
            <input id="new-signal-int-res-pupd" type="text" placeholder="int res pu/pd" style="float:right" />
            <br/>
            <label>External Resistor Pull-up/Pull-down:</label>
            <input id="new-signal-ext-res-pupd" type="text" placeholder="ext res pu/pd" style="float:right" />
            <br/>
            <label>Power Rail:</label>
            <input id="new-signal-power-rail" type="text" placeholder="power rail" style="float:right" />
            <br/>
            <label>Description:</label>
            <textarea id="new-signal-desc" type="text" style="width: 100%; float:right" ></textarea>
            <br/>
          </div>
          <div class="modal-footer">
            <button id="btn-add-interface-signal" type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div id="copyInterface" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Copy Interface</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h2>Source</h2>
            <label>Device Name:</label>
            <select id="src-interface-device-select" class="device-dialog" style="float:right">
            </select>
            <br/>
            <label>Interface Name:</label>
            <select id="src-interface-select" class="interfaces-dialog" style="float:right">
            </select>
            <br/>
            <label>Signals:</label>
            <select id="src-interface-signal-select" style="float:right">
            </select>
            <hr />
            <h2>Destination</h2>
            <label>Device Name:</label>
            <select id="copy-interface-device-select" class="device-dialog" style="float:right">
            </select>
            <br/>
            <label>Interface Name:</label>
            <select id="copy-interface-select" class="interfaces-dialog" style="float:right">
            </select>
            <br/>
            <label>Signals:</label>
            <select id="copy-interface-signal-select" style="float:right">
            </select>
          </div>
          <div class="modal-footer">
            <button id="btn-copy-interface-signal" type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <table>
      <tr>
        <td valign="top">
          <select id="device" size="10" style="width:200px; min-height: 300px"></select>
          
		  <br />
          
          <select id="interfaces" size="10" style="width:100%; min-height: 200px"></select>
        </td>
        <td valign="top">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addDevice">
            New Device...
          </button>

          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addInterface">
            New Interface...
          </button>

          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addSignal">
            New Signal...
          </button>

          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#copyInterface">
            Copy Interface...
          </button>

          <button id="btn-remove-signals" type="button" class="btn btn-danger" data-toggle="modal">
            Remove Signals...
          </button>
          
          <table id="main-table" class="display" cellspacing="0" width="100%">
            <thead>
              <tr>
                <th><input type="checkbox" id="toggle-select-all" /></th>
                <th>signal_id</th>
                <th>interface_id</th>
                <th>signal_name</th>
                <th>channels</th>
                <th>description</th>
                <th>attributes</th>
              </tr>
            </thead>
            <tbody id="table-body">

            </tbody>
          
          </table>

        </td>
      </tr>
    </table>
    
    
    <!-- Optional JavaScript -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script src="https://editor.datatables.net/extensions/Editor/js/dataTables.editor.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://editor.datatables.net/extensions/Editor/css/editor.dataTables.min.css"/>
 
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>

    <script>
      
      function getFootprints(device_id, cb){
        $.get('http://3.2.1.100:3000/api/device/footprints?id='+device_id,function(footprint_list){
        	if(cb) cb(footprint_list);
        })
      }
      
      function formatXml(xml, tab) { // tab = optional indent value, default is tab (\t)
        var formatted = '', indent= '';
        tab = tab || '\t';
        xml.split(/>\s*</).forEach(function(node) {
          if (node.match( /^\/\w/ )) indent = indent.substring(tab.length); // decrease indent by one 'tab'
          formatted += indent + '<' + node + '>\r\n';
          if (node.match( /^<?\w[^>]*[^\/]$/ )) indent += tab;              // increase indent
        });
        return formatted.substring(1, formatted.length-3);
      }

      function lookupBallName(signal, ball_map){
        for(var i = 0;i<ball_map.length;i++){
          var item = ball_map[i];	
          if(item.signal == signal || item.signal + "_" + item.ball == signal) 
            return item.ball;
        }
        return null;
      }
      
      
      
      function get_eagle_template(deviceName, packageName, smds, symbolXML, gates, connects){
              var package = '<package name="'+packageName+'">'+smds+'</package>';
              
              var symbols = '<symbols>'+symbolXML+'</symbols>'
              
              var deviceSet =    '<deviceset name="'+deviceName+'">\
                      <gates>'+gates+'</gates>\
                      <devices>\
                          <device name="" package="'+packageName+'">\
                              <connects>'+connects+'</connects>\
                              <technologies>\
                                  <technology name=""/>\
                              </technologies>\
                          </device>\
                      </devices>\
                  </deviceset>'
             
        	return {
              package: package,
              symbols: symbols,
              deviceSet: deviceSet
            }
      }

      function get_eagle_lib(){
        
        genXML(list=>{
		  var packages = "",
              symbols = "",
              device_sets = "";
          for(var i in list){
            packages += list[i].eagle_lib.package;
            symbols += list[i].eagle_lib.symbols;
            device_sets += list[i].eagle_lib.deviceSet;
          }
          
          var eagle_lib_xml = '<?xml version="1.0" encoding="utf-8"?>\
<!DOCTYPE eagle SYSTEM "eagle.dtd">\
<eagle version="9.4.2">\
    <drawing>\
        <settings>\
            <setting alwaysvectorfont="no"/>\
            <setting verticaltext="up"/>\
        </settings>\
        <grid distance="0.7" unitdist="mm" unit="mm" style="lines" multiple="1" display="no" altdistance="0.0875" altunitdist="mm" altunit="mm"/>\
        <layers>\
            <layer number="1" name="Top" color="4" fill="1" visible="yes" active="yes"/>\
            <layer number="16" name="Bottom" color="1" fill="1" visible="yes" active="yes"/>\
            <layer number="17" name="Pads" color="2" fill="1" visible="yes" active="yes"/>\
            <layer number="18" name="Vias" color="2" fill="1" visible="yes" active="yes"/>\
            <layer number="19" name="Unrouted" color="6" fill="1" visible="yes" active="yes"/>\
            <layer number="20" name="Dimension" color="24" fill="1" visible="yes" active="yes"/>\
            <layer number="21" name="tPlace" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="22" name="bPlace" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="23" name="tOrigins" color="15" fill="1" visible="yes" active="yes"/>\
            <layer number="24" name="bOrigins" color="15" fill="1" visible="yes" active="yes"/>\
            <layer number="25" name="tNames" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="26" name="bNames" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="27" name="tValues" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="28" name="bValues" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="29" name="tStop" color="7" fill="3" visible="no" active="yes"/>\
            <layer number="30" name="bStop" color="7" fill="6" visible="no" active="yes"/>\
            <layer number="31" name="tCream" color="7" fill="4" visible="no" active="yes"/>\
            <layer number="32" name="bCream" color="7" fill="5" visible="no" active="yes"/>\
            <layer number="33" name="tFinish" color="6" fill="3" visible="no" active="yes"/>\
            <layer number="34" name="bFinish" color="6" fill="6" visible="no" active="yes"/>\
            <layer number="35" name="tGlue" color="7" fill="4" visible="no" active="yes"/>\
            <layer number="36" name="bGlue" color="7" fill="5" visible="no" active="yes"/>\
            <layer number="37" name="tTest" color="7" fill="1" visible="no" active="yes"/>\
            <layer number="38" name="bTest" color="7" fill="1" visible="no" active="yes"/>\
            <layer number="39" name="tKeepout" color="4" fill="11" visible="yes" active="yes"/>\
            <layer number="40" name="bKeepout" color="1" fill="11" visible="yes" active="yes"/>\
            <layer number="41" name="tRestrict" color="4" fill="10" visible="yes" active="yes"/>\
            <layer number="42" name="bRestrict" color="1" fill="10" visible="yes" active="yes"/>\
            <layer number="43" name="vRestrict" color="2" fill="10" visible="yes" active="yes"/>\
            <layer number="44" name="Drills" color="7" fill="1" visible="no" active="yes"/>\
            <layer number="45" name="Holes" color="7" fill="1" visible="no" active="yes"/>\
            <layer number="46" name="Milling" color="3" fill="1" visible="no" active="yes"/>\
            <layer number="47" name="Measures" color="7" fill="1" visible="no" active="yes"/>\
            <layer number="48" name="Document" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="49" name="Reference" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="51" name="tDocu" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="52" name="bDocu" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="88" name="SimResults" color="9" fill="1" visible="yes" active="yes"/>\
            <layer number="89" name="SimProbes" color="9" fill="1" visible="yes" active="yes"/>\
            <layer number="90" name="Modules" color="5" fill="1" visible="yes" active="yes"/>\
            <layer number="91" name="Nets" color="2" fill="1" visible="yes" active="yes"/>\
            <layer number="92" name="Busses" color="1" fill="1" visible="yes" active="yes"/>\
            <layer number="93" name="Pins" color="2" fill="1" visible="yes" active="yes"/>\
            <layer number="94" name="Symbols" color="4" fill="1" visible="yes" active="yes"/>\
            <layer number="95" name="Names" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="96" name="Values" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="97" name="Info" color="7" fill="1" visible="yes" active="yes"/>\
            <layer number="98" name="Guide" color="6" fill="1" visible="yes" active="yes"/>\
        </layers>\
        <library>\
            <packages>\
            '+packages+'\
            </packages>\
            '+symbols+'\
            <devicesets>\
                '+device_sets+'\
            </devicesets>\
        </library>\
    </drawing>\
</eagle>';
			console.log(formatXml(eagle_lib_xml))
        })
      }
      
      function genXML(cb){
        getAllDevices(list => {
          
          console.log(list);
         
          var result = [],
              counter = 0;
          
          
          function processDevice(device){
            getFootprints(device.device_id, footprint_list => {
              
              
             
              
              
                var interfaces = device.interfaces;
                var connects="", gates="", gatePrefix="";
                var symbolXML = '', x = 0, y = 0, stepSize = 5.08;
                var smds = '';
                
                for(var i in footprint_list){
                  var footprint = footprint_list[i];
                  var dim = JSON.parse(footprint.dimensions);
                  var signal_name = footprint.signal;
                  smds += '<smd name="'+signal_name+'" x="'+dim.x+'" y="'+dim.y+'" dx="0.45" dy="0.45" layer="1" roundness="100"/>\n';
                }
                
                for(var i=0;i<interfaces.length;i++){
                  //if(interfaces[i].Interface == "Reserved Signals") continue;
                  var interface_name = (device.name + "-" + interfaces[i].name.split(' ').join('-'));
                  symbolXML += '<symbol name="' + interface_name + '">\n';

                  gates += '<gate name="'+gatePrefix+interface_name+'" symbol="'+interface_name+'" x="0" y="0"/>\n';

                  //var startY = 1 * (interfaces[i].Signals.length * stepSize/*mm*/) / 2;

                  y = 0;
                  var smd_x = 0, smd_y = 0;
                  for(var p=0;p<interfaces[i].signals.length;p++){
                    
                    var signal = interfaces[i].signals[p];
       
                    for(var n=0;n<signal.net_list.length;n++){
                      if(y >= 2000){
                        y = 0;
                        x += stepSize * 2;
                      }
                      
                      if(n%4 == 0) {
                        smd_y = 0;
                        smd_x += 0.7;
                      }
                      
                      var pinName = signal.net_list[n];
                      symbolXML += '    <pin name="'+pinName+'"  x="'+x+'" y="'+y+'" length="middle" />\n';

                      

                      
                      if(footprint_list.length > 0){
                      	connects += '<connect gate="'+gatePrefix+interface_name+'" pin="'+pinName+'" pad="'+pinName+'" />\n';
                      }
                      else {
                        connects += '<connect gate="'+gatePrefix+interface_name+'" pin="'+pinName+'" pad="'+pinName+'" />\n';
						smds += '<smd name="'+pinName+'" x="'+smd_x+'" y="'+smd_y+'" dx="0.45" dy="0.45" layer="1" roundness="100"/>\n';
                        
                      }
                      

                      y += stepSize;
                      smd_y += 0.7;
                    }
                  }

                  var boxWidth = stepSize * 8;
                  var wires = [
                    { x1: x + stepSize, y1: stepSize * -2, x2: x + stepSize, y2: y + stepSize },
                    { x1: x + boxWidth, y1: stepSize * -2, x2: x + boxWidth, y2: y + stepSize },

                    { x1: x + stepSize, y1: stepSize * -2, x2: x + boxWidth, y2: stepSize*-2 },
                    { x1: x + stepSize, y1: y + stepSize , x2: x + boxWidth, y2: y + stepSize },

                    //{ x1: ,y1: ,x2: ,y1: },
                    //{ x1: ,y1: ,x2: ,y1: },
                    //{ x1: ,y1: ,x2: ,y1: }  
                  ], 
                      textX = x + stepSize, 
                      textY = stepSize*-3;

                  for(var w in wires){
                    symbolXML += '<wire x1="'+wires[w].x1+'" y1="'+wires[w].y1+'" x2="'+wires[w].x2+'" y2="'+wires[w].y2+'" width="0.254" layer="94"/>\n';
                  }


                  symbolXML += '<text x="'+textX+'" y="'+textY+'" size="1.778" layer="94">'+interface_name+'</text>\n';

                  symbolXML += '</symbol>\n';
                }



                device.eagle_lib = get_eagle_template(device.name, device.name, smds, symbolXML, gates, connects);

                device.template = { 
                  connects: connects, 
                  symbol: symbolXML, 
                  gates: gates,
                  smds: smds
                }

                result.push(device)

                if(counter++ == list.length - 1){
                  if(cb) cb(result)
                    }
                else {
                  processDevice(list[counter])
                }
              
            });
          }

          processDevice(list[counter])
          
        })
      }


      function getAllDevices(cb){
        $.get('http://3.2.1.100:3000/api/device/list',function(device_list){
          var result=[];
          var counter = 0;
          function processDevice(device_id){
            getDeviceSignals(device_id, device => {
              result.push({
                name: device_list[counter].device_name,
                device_id: device_id,
                interfaces: device.interfaces
              })
              if(counter++ == device_list.length -1){
                if(cb) cb(result)
                  }
              else processDevice(device_list[counter].device_id);
            })
          }
          if(device_list.length > 0){
            processDevice(device_list[counter].device_id);
          }
          else {
            if(cb) cb(result)
              }
        });
      }

      function getDeviceSignals(device_id, cb){
        $.get('http://3.2.1.100:3000/api/device/interface/list?id='+device_id,function(interface_list){
          //loop through device interface list
          var counter = 0, results = [];
          //console.log(interface_list)
          function lookupInterfaceName(id){
            for(var i in interface_list){
              if(interface_list[i].interface_id == id){
                return interface_list[i].interface_name;
              }
            }
            return null;
          }
          function fetchSignals(interface_id){
            $.get('http://3.2.1.100:3000/api/device/interface/signals?id='+interface_id, function(signals){
              for(var i in signals){
                signals[i].net_list = [];
                for(var n = 0;n<signals[i].channels;n++){
                  var sigName = signals[i].name, 
                      net_name = '';
                  if(signals[i].channels > 1){
                    net_name = sigName.substr(0, sigName.indexOf('[')) + '[' + n + ']'
                  }
                  else net_name = sigName;
                  signals[i].net_list.push(net_name)
                }
              }
              results.push({ 
                name: lookupInterfaceName(interface_id),
                interface_id: interface_id, 
                signals: signals
              })
              if(counter++ == interface_list.length - 1){
                if(cb) cb({
                  device_id: device_id,
                  interfaces: results
                });
              }
              else {
                fetchSignals(interface_list[counter].interface_id)
              }
            });
          }
          if(interface_list.length  > 0) {
            //seed loop
            fetchSignals(interface_list[counter].interface_id)
          }
          else {
            cb({
              device_id: device_id,
              interfaces: results
            }); 
          }
        });       
      }
      
      function getDeviceBallSignalMap(device_id, cb){
        $.get('http://3.2.1.100:3000/api/device/ball_signal_map?id='+device_id,function(map_data){
          if(cb) cb(map_data);
        });
      }

      function getDevices(cb){
        $.get('http://3.2.1.100:3000/api/device/list',function(data){
          var html = '<option></option>';
          for(var i in data){
            html += '<option value="'+data[i].device_id+'">'+data[i].device_name+'</option>'
          }
          $('#device').html(html);
          if(cb) cb(data);
        });
      }

      function getInterfaces(device_id, interfaceSelectElement){
        $.get('http://3.2.1.100:3000/api/device/interface/list?id='+device_id,function(data){
          var html = '<option></option>';
          for(var i in data){
            html += '<option value="'+data[i].interface_id+'">'+data[i].interface_name+'</option>'
          }
          $(interfaceSelectElement).html(html);
        });
      }

      function loadInterfaceSignals(interface_id){
        html = "";
        $.get('http://3.2.1.100:3000/api/device/interface/signals?id='+interface_id, function(data){

          for(var i in data){
            var cols = Object.keys(data[i]);
            html += '<tr>';
            html += '<td><input type="checkbox" value="'+(data[i][cols[0]])+'" /></td>';
            for(var j in cols){
              var val = data[i][cols[j]];
              html += '<td name="'+cols[j]+'">'+(val)+'</td>';
            }
            html += '</tr>';
          }
          $('#table-body').html(html);
        });
      }

      function populateInterfaceOptions(device_id, interfaceSelectElement){
        $.get('http://3.2.1.100:3000/api/device/interface/list?id='+device_id, function(data){
          var html = '<option></option>';
          for(var i in data){
            html += '<option value="'+data[i].interface_id+'">'+data[i].interface_name+'</option>'
          }
          $(interfaceSelectElement).html(html);
        });
      }

      function populateSignalsOptions(interface_id, signalSelectElement){
        var html = '';
        $.get('http://3.2.1.100:3000/api/device/interface/signals?id='+interface_id,function(data){
          for(var i in data) {
            html += '<option value="'+data[i].signal_id+'">'+data[i].name+'</option>'; 
          }
          $(signalSelectElement).html(html);
        });
      }

      function setNewSignalValues(signalObject){
        $('#new-signal-name').val(signalObject.name)
        $('#new-signal-io-type').val(signalObject.io_type)
        $('#new-signal-io-buffer-type').val(signalObject.io_buffer_type)
        $('#new-signal-ball-count').val(signalObject.channels)
        $('#new-signal-int-res-pupd').val(signalObject.int_res_pu_pd)
        $('#new-signal-ext-res-pupd').val(signalObject.ext_res_pu_pd)
        $('#new-signal-power-rail').val(signalObject.power_rail)
        $('#new-signal-desc').val(signalObject.description)
      }

      function getNewSignalValues(){
        var json={
          signal:$('#new-signal-name').val(),
          io_type:$('#new-signal-io-type').val(),
          io_buffer_type:$('#new-signal-io-buffer-type').val(),
          channels:$('#new-signal-ball-count').val(),
          int_res_pu_pd:$('#new-signal-int-res-pupd').val(),
          ext_res_pu_pd:$('#new-signal-ext-res-pupd').val(),
          power_rail:$('#new-signal-power-rail').val(),
          description: $('#new-signal-desc').val()
        };
        return json;
      }

      $(document).ready(function(){
        window.editor = new $.fn.dataTable.Editor( {
          ajax: "http://3.2.1.100:3000/api/device/interface/signals",
          table: '#main-table',
          fields: [ 
            {
              label: "signal_id:",
              name: "signal_id"
            }, 
            {
              label: "interface_id:",
              name: "interface_id"
            }, 
            {
              label: "signal name:",
              name: "signal_name"
            }, 
            
            {
              label: "channels:",
              name: "channels"
            }, 
            
            {
              label: "description:",
              name: "description"
            }, 
            {
              label: "attributes:",
              name: "attributes"
            }
          ]
        } );
        
       
        $('#main-table tbody').on( 'click', 'tbody td:not(:first-child)', function (e) {
          console.log(this);
          editor.inline( this );
        } );
        
        
        window.dataTable = $('#main-table').DataTable( {
          dom: "Bfrtip",
          "paging": false,
          select: true,
          //"processing": true,
          //"serverSide": true,
          "ajax": {
            "url": "http://3.2.1.100:3000/api/device/interface/signals",
            "data": function ( d ) {
              d.id = $('#interfaces').val() || 0;
            }
          },
          "columns": [
            {
                data: null,
                defaultContent: '',
                className: 'select-checkbox',
                orderable: false
            },
            { "data": "signal_id", orderable: false },
            { "data": "interface_id", orderable: false },
            { "data": "signal_name", orderable: false },         
            { "data": "channels", orderable: false },
            { "data": "description", orderable: false },
            { "data": "attributes", orderable: false }
          ],
          //rowCallback: function(row, data, index) {
            //$('td', row).eq(0).html('<input type="checkbox" value="'+data.signal_id+'" />');
            //console.log(row, data, index);
            //if (data.status == "Active") {
            //  $("td:eq(4)", row).addClass("active");
            //}
          //},
          //select: {
          //  style:    'os',
          //  selector: 'td:first-child',
          //},
          buttons: [
            { extend: "create", editor: editor },
            { extend: "edit",   editor: editor },
            { extend: "remove", editor: editor }
          ]
        } )
        
        
        
        
        $('#device').on('change', function (e) {
          var optionSelected = $("option:selected", this);
          var valueSelected = this.value;
          getInterfaces(valueSelected, '#interfaces');
        });

        $('#interfaces').on('change', function (e) {
          var optionSelected = $("option:selected", this);
          var valueSelected = this.value;
          //loadInterfaceSignals(valueSelected);
          dataTable.ajax.reload();
        });

        getDevices(function(data){
          //copy device options to all .device-dialog elements
          var opts = document.getElementById('device').options, html = '';
          for(var i=0; i<opts.length; i++) {
            html += '<option value="' + opts[i].value + '">' + ( opts[i].text) + '</option>'; 
          }
          $('.device-dialog').html(html);
        });


        $('#device-select').on('change', function(){
          populateInterfaceOptions($('#device-select').val(), '#interfaces'); 
        });


        $('#new-signal-device-select').on('change', function(){
          populateInterfaceOptions($('#new-signal-device-select').val(), '#new-signal-interface-select'); 
        });

        $('#new-signal-interface-select').on('change', function(){
          populateSignalsOptions($('#new-signal-interface-select').val(), '#new-signal-select');
        });

        $('#src-interface-device-select').on('change', function(){
          populateInterfaceOptions($('#src-interface-device-select').val(), '#src-interface-select'); 
        });

        $('#src-interface-select').on('change', function(){
          populateSignalsOptions($('#src-interface-select').val(), '#src-interface-signal-select');
        });

        $('#copy-interface-device-select').on('change', function(){
          populateInterfaceOptions($('#copy-interface-device-select').val(), '#copy-interface-select'); 
        });

        $('#copy-interface-select').on('change', function(){
          populateSignalsOptions($('#copy-interface-select').val(), '#copy-interface-signal-select');
        });


        $('#btn-add-device').click(function(){
          $.get('http://3.2.1.100:3000/api/device/add?name='+$('#new-device-name').val(), function(data){
            console.log(data);
          });
        });


        $('#btn-add-interface').click(function(){
          $.get('http://3.2.1.100:3000/api/device/interface/add?id='+$('#new-interface-device-select').val()+'&name='+$('#new-interface-name').val(), function(data){
            console.log(data);
          });
        });


        $('#btn-add-interface-signal').click(function(){
          var interface_id = $('#new-signal-interface-select').val();
          $.get('http://3.2.1.100:3000/api/device/interface/signal/add?id='+interface_id+'&signal='+encodeURIComponent(JSON.stringify(getNewSignalValues())), function(data){
            console.log(data);
          });
        });

        $('#btn-copy-interface-signal').click(function(){
          var src_interface_id = $('#src-interface-select').val(),
              dest_interface_id = $('#copy-interface-select').val();
          $.get('http://3.2.1.100:3000/api/device/interface/signals/copy?id='+src_interface_id+'&dest_id='+dest_interface_id, function(data){
            console.log(data);
          });
        });




        $('#btn-copy-interface-signal').click(function(){

        });

        $('#btn-remove-signals').click(function(){
          var interface_id = $('#interfaces').val(), signal_ids = $('input[type=checkbox]:checked').toArray();
          var sure = confirm('Are you sure you want to delete '+signal_ids.length+' signals from "'+ $('#interfaces option:selected').text()+'"?');
          if(sure){
            for(var i in signal_ids){
              if(signal_ids[i].id == "toggle-select-all") continue;
              var signal_id = signal_ids[i].value;
              $.get('http://3.2.1.100:3000/api/device/interface/signal/remove?id='+interface_id+'&signal_id='+signal_id, function(data){
                console.log(data);
              });
            }
          }
        });


        $('#toggle-select-all').click(function(){
          if($(this).is(':checked')){
            $('input[type=checkbox]').prop('checked', true);
          }
          else {
            $('input[type=checkbox]').prop('checked', false);
          }
        })

      });

    </script>


  </body>
</html>
